class RuianAddressWidget{constructor(t){this.inputElement=t.inputElement,this.suggestionBox=t.suggestionElement,this.apiKey=t.apiKey,this.onValidationChange=t.onValidationChange||function(){},this.onLog=t.onLog||console.log,this.state={municipalityId:null,municipalityName:null,zip:null,streetName:null},this.debounceTimer=null,this.suggestionsData=[],this.activeIndex=-1,this.init()}setApiKey(t){this.apiKey=t}init(){this.log("Initializing RUIAN Widget...","INFO"),this.inputElement.addEventListener("input",t=>{clearTimeout(this.debounceTimer),this.inputElement.classList.remove("is-valid","is-invalid"),this.debounceTimer=setTimeout(()=>{this.handleInput(t.target.value)},400)}),this.inputElement.addEventListener("keydown",t=>this.handleKeydown(t)),document.addEventListener("click",t=>{t.target!==this.inputElement&&!this.suggestionBox.contains(t.target)&&this.closeSuggestions()})}formatZip(t){if(!t)return"";const e=String(t).replace(/\s/g,"");return 5===e.length?e.substring(0,3)+" "+e.substring(3):e}async handleInput(t){if(!t||t.trim().length<1)return this.closeSuggestions(),void this.triggerCallback(null);const e=t.split(",").map(t=>t.trim()),s=e.length-1,i=e[s];0===s&&this.state.municipalityName&&(t.toLowerCase().startsWith(this.state.municipalityName.toLowerCase().substring(0,Math.min(t.length,this.state.municipalityName.length)))||(this.log("Resetting context","WARN"),this.resetState())),await this.tryAutoSelectContext(e);let n=[];if(t.length>5&&/\d/.test(t)){const e=await this.apiValidate(t);if(e&&"MATCH"===e.status){this.log("Address is VALID","SUCCESS");const s=e.place,i=this.mapToRuianPlace(s);this.triggerCallback(i);const a=s.streetName||s.municipalityPartName||s.municipalityName;let r=s.cp||"";s.co&&(r+="/"+s.co),s.ce&&(r="ev."+s.ce);const o=`${a} ${r}, ${this.formatZip(s.zip)} ${s.municipalityName}`,l=t=>t.replace(/\s+/g," ").trim();return l(t)!==l(o)&&n.unshift({type:"complete",label:o,value:o,data:s}),void this.renderSuggestions(n)}this.triggerCallback(!1)}try{if(!this.state.municipalityId||0===s){const t=await this.searchMunicipality(i);n=n.concat(t),0===t.length&&e.length>1&&!this.state.municipalityId&&(await this.searchMunicipality(e[0])).length>0&&(n=n.concat(await this.searchMunicipality(e[0])))}else if(this.state.municipalityId&&!this.isNumber(i)&&1===s){this.log(`Searching street ID ${this.state.municipalityId}`,"INFO");const t=await this.searchStreet(this.state.municipalityId,i);n=n.concat(t),0===t.length&&""===i.trim()&&(n=n.concat(await this.searchPlace(this.state.municipalityId,null,i)))}else this.state.municipalityId&&(n=n.concat(await this.searchPlace(this.state.municipalityId,this.state.streetName,i)))}catch(t){this.log(`Error: ${t.message}`,"ERROR")}this.renderSuggestions(n)}async tryAutoSelectContext(t){if(!this.state.municipalityId&&t.length>1){const e=t[0];if(e.length>1){const t=await this.searchMunicipality(e),s=t.find(t=>t.value.toLowerCase()===e.toLowerCase());s&&(this.log(`Auto-selected Municipality: ${s.label}`,"INFO"),this.state.municipalityId=s.data.municipalityId,this.state.municipalityName=s.data.municipalityName,this.state.zip=s.data.zip)}}if(this.state.municipalityId&&!this.state.streetName&&t.length>2){const e=t[1];if(e.length>0&&!this.isNumber(e)){const s=await this.searchStreet(this.state.municipalityId,e),i=s.find(t=>t.value.toLowerCase()===e.toLowerCase());i&&(this.log(`Auto-selected Street: ${i.value}`,"INFO"),this.state.streetName=i.value)}}}mapToRuianPlace(t){return{valid:!0,municipalityId:t.municipalityId,municipalityName:t.municipalityName,municipalityPartId:t.municipalityPartId||null,municipalityPartName:t.municipalityPartName||null,streetName:t.streetName||null,ce:t.ce||null,cp:t.cp||null,co:t.co||null,zip:t.zip,id:t.id,ruianId:t.id,regionId:t.regionId||null,regionName:t.regionName||null,originalString:this.inputElement.value}}async apiValidate(t){if(!this.apiKey)return this.log("Missing API Key!","ERROR"),null;let e=`https://ruian.fnx.io/api/v1/ruian/validate?apiKey=${this.apiKey}`;const s=t.match(/^(.+?)\s+(\d+(?:\/\d+)?[a-zA-Z]?)[,\s]+(\d{3}\s?\d{2})\s+(.+)$/);if(s){this.log("Format: 'Street Number, ZIP City'","INFO");const t=s[1].trim(),i=s[2].trim(),n=s[3].replace(/\s/g,""),a=s[4].trim();let r=null,o=null;return this.parseNumber(i,(t,e)=>{r=t,o=e}),e+=`&municipalityName=${encodeURIComponent(a)}`,e+=`&street=${encodeURIComponent(t)}`,e+=`&zip=${n}`,r&&(e+=`&cp=${r}`),o&&(e+=`&co=${o}`),this.fetchJson(e)}let i=this.state.municipalityName,n=this.state.streetName,a=null,r=null,o=null,l=t;const c=t.match(/\b\d{3}\s?\d{2}\b/);c?(o=c[0].replace(/\s/g,""),l=l.replace(c[0],"")):this.state.zip&&(o=this.state.zip);const u=l.split(/[,]+/).map(t=>t.trim()).filter(t=>t.length>0);let h=!1;for(let t=0;t<u.length;t++){const e=u[t],s=e.match(/(\d+(?:\/\d+)?[a-zA-Z]?)$/);if(s){const i=s[1],n=e.substring(0,e.length-i.length).trim();if(0===n.length||n.length>2){n.length>2&&!this.state.streetName&&(this.state.streetName=n),this.parseNumber(i,(t,e)=>{a=t,r=e}),h=!0,u[t]=null}if(h)break}}const d=u.filter(t=>null!==t);return!i&&d.length>0&&(d.length>=2?(!n&&(n=d[0]),i=d[d.length-1]):1===d.length&&(n?i=d[0]:this.state.municipalityId?n=d[0]:i=d[0])),!n&&this.state.streetName&&(n=this.state.streetName),!i&&this.state.municipalityName&&(i=this.state.municipalityName),i&&(e+=`&municipalityName=${encodeURIComponent(i)}`),n&&(e+=`&street=${encodeURIComponent(n)}`),a&&(e+=`&cp=${a}`),r&&(e+=`&co=${r}`),o&&(e+=`&zip=${o}`),this.fetchJson(e)}parseNumber(t,e){const s=t.split("/"),i=s[0].replace(/\D/g,"");if(i&&e(i,null),s[1]){const t=s[1].replace(/\D/g,"");t&&e(i,t)}}async searchMunicipality(t){if(/^\d/.test(t)||t.length<1||!this.apiKey)return[];const e=`municipalityName=${encodeURIComponent(t)}&cp=1`,s=`https://ruian.fnx.io/api/v1/ruian/validate?apiKey=${this.apiKey}&${e}`,i=await this.fetchJson(s);return i&&i.place&&"ERROR"!==i.status&&"NOT_FOUND"!==i.status?[{type:"municipality",label:`${i.place.municipalityName}`,value:i.place.municipalityName,data:i.place}]:[]}async searchStreet(t,e){if(!this.apiKey)return[];const s=`https://ruian.fnx.io/api/v1/ruian/build/streets?apiKey=${this.apiKey}&municipalityId=${t}`,i=await this.fetchJson(s);if(!i||!i.data)return[];const n=e.toLowerCase();return i.data.filter(t=>{const e=t.streetName||t.streetLessPartName;return e&&e.toLowerCase().includes(n)}).slice(0,10).map(t=>({type:"street",label:t.streetName||t.streetLessPartName,value:t.streetName||t.streetLessPartName,data:t}))}async searchPlace(t,e,s){if(!this.apiKey)return[];let i=`https://ruian.fnx.io/api/v1/ruian/build/places?apiKey=${this.apiKey}&municipalityId=${t}`;e&&(i+=`&streetName=${encodeURIComponent(e)}`);const n=await this.fetchJson(i);if(!n||!n.data)return[];const a=s.toLowerCase().trim(),r=n.data.map(t=>{let e="";return t.placeCp&&(e+=t.placeCp),t.placeCo&&(e+="/"+t.placeCo),t.placeCe&&(e="ev."+t.placeCe),{type:"place",label:e,value:e,data:t}});return r.filter(t=>{if(!a)return!0;if(t.label.toLowerCase().startsWith(a))return!0;const e=t.data.placeCo?String(t.data.placeCo).toLowerCase():"";return!(!e.startsWith(a)||(t.data.placeCp?String(t.data.placeCp).toLowerCase():"").startsWith(a))}).slice(0,10)}async fetchJson(t){const e=t.replace(this.apiKey,"***");this.log(`GET ${e}`,"INFO");try{const e=await fetch(t);if(!e.ok)return this.log(`HTTP Error: ${e.status} ${e.statusText}`,"ERROR"),null;const s=await e.json();let i=JSON.stringify(s);return i.length>200&&(i=i.substring(0,200)+"..."),this.log(`Response: ${i}`,"INFO"),s}catch(t){return this.log(`Network Error: ${t.message}`,"ERROR"),null}}renderSuggestions(t){if(this.suggestionBox.innerHTML="",this.suggestionsData=t,this.activeIndex=t.length>0&&"complete"===t[0].type?0:-1,!t||0===t.length)return this.closeSuggestions(),void 0;t.forEach((t,e)=>{const s=document.createElement("button");s.className="list-group-item list-group-item-action suggestion-item d-flex align-items-center justify-content-between",e===this.activeIndex&&s.classList.add("active");let i="bg-secondary";"municipality"===t.type&&(i="bg-primary"),"street"===t.type&&(i="bg-warning text-dark"),"place"===t.type&&(i="bg-info text-dark"),"complete"===t.type&&(i="bg-success",s.classList.add("suggestion-complete")),s.innerHTML=`\n                <span>${t.label}</span>\n                <span class="badge ${i} badge-type">${t.type}</span>\n            `,s.onclick=t=>{t.preventDefault(),this.selectSuggestion(e)},this.suggestionBox.appendChild(s)}),this.suggestionBox.style.display="block"}selectSuggestion(t){const e=this.suggestionsData[t];if(e){if(this.log(`Selected: ${e.type} - ${e.label}`,"SUCCESS"),"complete"===e.type){this.inputElement.value=e.value;const t=this.mapToRuianPlace(e.data);this.triggerCallback(t),this.state.municipalityId=e.data.municipalityId,this.state.municipalityName=e.data.municipalityName,this.state.zip=e.data.zip,this.state.streetName=e.data.streetName||null,this.closeSuggestions()}else if("municipality"===e.type){this.state.municipalityId=e.data.municipalityId,this.state.municipalityName=e.data.municipalityName,this.state.zip=e.data.zip,this.state.streetName=null,this.inputElement.value=`${e.data.municipalityName}, `,this.handleInput(this.inputElement.value),this.inputElement.focus()}else if("street"===e.type){this.state.streetName=e.value,this.inputElement.value=`${this.state.municipalityName}, ${e.value}, `,this.handleInput(this.inputElement.value),this.inputElement.focus()}else if("place"===e.type){let t=`${this.state.municipalityName}, `;this.state.streetName&&(t+=`${this.state.streetName}, `);const s=e.data.placeZip||this.state.zip;this.inputElement.value=`${t}${e.value}, ${this.formatZip(s)}`,this.handleInput(this.inputElement.value),this.inputElement.focus()}}}closeSuggestions(){this.suggestionBox&&(this.suggestionBox.style.display="none"),this.activeIndex=-1}handleKeydown(t){if(this.suggestionBox&&"none"!==this.suggestionBox.style.display){const e=this.suggestionBox.querySelectorAll(".suggestion-item");"ArrowDown"===t.key?(t.preventDefault(),this.activeIndex=(this.activeIndex+1)%e.length,this.highlightItem(e)):"ArrowUp"===t.key?(t.preventDefault(),this.activeIndex=(this.activeIndex-1+e.length)%e.length,this.highlightItem(e)):"Enter"===t.key?(t.preventDefault(),this.activeIndex>-1&&this.selectSuggestion(this.activeIndex)):"Escape"===t.key&&this.closeSuggestions()}}highlightItem(t){t.forEach(t=>t.classList.remove("active")),t[this.activeIndex]&&(t[this.activeIndex].classList.add("active"),t[this.activeIndex].scrollIntoView({block:"nearest"}))}isNumber(t){return/^\d/.test(t.trim())}resetState(){this.state={municipalityId:null,municipalityName:null,zip:null,streetName:null}}triggerCallback(t){!1===t?(this.inputElement.classList.add("is-invalid"),this.inputElement.classList.remove("is-valid"),this.onValidationChange(!1,null)):null===t?(this.inputElement.classList.remove("is-valid","is-invalid"),this.onValidationChange(null,null)):(this.inputElement.classList.remove("is-invalid"),this.inputElement.classList.add("is-valid"),this.onValidationChange(!0,{RUIANplace:t}))}log(t,e){this.onLog(t,e)}}