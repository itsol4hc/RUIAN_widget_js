class RuianAddressWidget{constructor(t){this.inputElement=t.inputElement,this.suggestionBox=t.suggestionElement,this.apiKey=t.apiKey,this.onValidationChange=t.onValidationChange||function(){},this.onLog=t.onLog||console.log,this.cachePreservation=void 0!==t.cachePreservation?t.cachePreservation:24,this.cacheReset=t.cacheReset||!1,this.state={municipalityId:null,municipalityName:null,zip:null,streetName:null},this.allMunicipalities=null,this.municipalitiesLoading=!1,this.zipCache={},this.debounceTimer=null,this.suggestionsData=[],this.activeIndex=-1,this.cacheReset&&(localStorage.removeItem("ruian_municipalities_cache"),this.log("Cache reset on init","INFO")),this.init()}setApiKey(t){this.apiKey=t}init(){this.log("Initializing RUIAN Widget v1.1...","INFO"),this.inputElement.addEventListener("input",t=>{clearTimeout(this.debounceTimer),this.inputElement.classList.remove("is-valid","is-invalid"),this.debounceTimer=setTimeout(()=>{this.handleInput(t.target.value)},400)}),this.inputElement.addEventListener("keydown",t=>this.handleKeydown(t)),document.addEventListener("click",t=>{t.target===this.inputElement||this.suggestionBox.contains(t.target)||this.closeSuggestions()})}formatZip(t){if(!t)return"";let i=String(t).replace(/\s/g,"");return 5===i.length?`${i.substring(0,3)} ${i.substring(3)}`:i}loadMunicipalitiesFromCache(){try{let t=localStorage.getItem("ruian_municipalities_cache");if(!t)return null;let i=JSON.parse(t),e=(Date.now()-i.timestamp)/36e5;if(e>this.cachePreservation)return this.log(`Cache expired (${e.toFixed(1)}h > ${this.cachePreservation}h)`,"INFO"),null;return this.log(`Loaded ${i.municipalities.length} municipalities from cache (${e.toFixed(1)}h old)`,"SUCCESS"),i.municipalities}catch(a){return null}}saveMunicipalitiesToCache(t){try{let i={timestamp:Date.now(),municipalities:t};localStorage.setItem("ruian_municipalities_cache",JSON.stringify(i)),this.log(`Saved ${t.length} municipalities to cache`,"SUCCESS")}catch(e){this.log(`Failed to cache municipalities: ${e.message}`,"WARN")}}async loadAllMunicipalities(){if(this.allMunicipalities)return this.allMunicipalities;let t=this.loadMunicipalitiesFromCache();if(t)return this.allMunicipalities=t,t;if(this.municipalitiesLoading){for(;this.municipalitiesLoading;)await new Promise(t=>setTimeout(t,100));return this.allMunicipalities||[]}this.municipalitiesLoading=!0,this.log("Loading all municipalities from API...","INFO");try{let i=[];for(let e of["CZ010","CZ020","CZ031","CZ032","CZ041","CZ042","CZ051","CZ052","CZ053","CZ063","CZ064","CZ071","CZ072","CZ080"]){let a=`https://ruian.fnx.io/api/v1/ruian/build/municipalities?apiKey=${this.apiKey}&regionId=${e}`,s=await this.fetchJson(a);s&&s.data&&s.data.forEach(t=>{i.push({municipalityId:t.municipalityId,municipalityName:t.municipalityName,regionId:e,regionName:this.getRegionName(e)})})}this.allMunicipalities=i,this.log(`Loaded ${i.length} municipalities`,"SUCCESS"),this.saveMunicipalitiesToCache(i)}catch(l){this.log(`Error loading municipalities: ${l.message}`,"ERROR")}return this.municipalitiesLoading=!1,this.allMunicipalities||[]}getRegionName(t){return({CZ010:"Hlavn\xed město Praha",CZ020:"Středočesk\xfd kraj",CZ031:"Jihočesk\xfd kraj",CZ032:"Plzeňsk\xfd kraj",CZ041:"Karlovarsk\xfd kraj",CZ042:"\xdasteck\xfd kraj",CZ051:"Libereck\xfd kraj",CZ052:"Kr\xe1lov\xe9hradeck\xfd kraj",CZ053:"Pardubick\xfd kraj",CZ063:"Kraj Vysočina",CZ064:"Jihomoravsk\xfd kraj",CZ071:"Olomouck\xfd kraj",CZ072:"Zl\xednsk\xfd kraj",CZ080:"Moravskoslezsk\xfd kraj"})[t]||t}async fetchMunicipalityZip(t){if(this.zipCache[t])return this.zipCache[t];let i=null;try{let e=`https://ruian.fnx.io/api/v1/ruian/validate?apiKey=${this.apiKey}&municipalityId=${t}&cp=1`,a=await this.fetchJson(e);a&&a.place&&(i=a.place.zip||a.place.placeZip)}catch(s){}if(!i)try{let l=`https://ruian.fnx.io/api/v1/ruian/build/places?apiKey=${this.apiKey}&municipalityId=${t}&streetName=-&limit=1`,n=await this.fetchJson(l);n&&n.data&&n.data.length>0?i=n.data[0].placeZip||n.data[0].zip:n&&n.length>0&&(i=n[0].placeZip||n[0].zip)}catch(r){}if(!i)try{let c=`https://ruian.fnx.io/api/v1/ruian/build/streets?apiKey=${this.apiKey}&municipalityId=${t}&limit=1`,h=await this.fetchJson(c),u=h&&h.data?h.data:h;if(u&&u.length>0){let p=u[0].streetName,o=`https://ruian.fnx.io/api/v1/ruian/build/places?apiKey=${this.apiKey}&municipalityId=${t}&streetName=${encodeURIComponent(p)}&limit=1`,m=await this.fetchJson(o),g=m&&m.data?m.data:m;g&&g.length>0&&(i=g[0].placeZip||g[0].zip)}}catch(d){this.log(`Error fetching ZIP for ${t}: ${d.message}`,"ERROR")}return i?(this.zipCache[t]=i,i):null}async handleInput(t){if(!t||t.trim().length<1){this.closeSuggestions(),this.triggerCallback(null);return}let i=t.split(",").map(t=>t.trim()),e=i.length-1,a=i[e];if(0===e&&this.state.municipalityName){let s=t.toLowerCase(),l=this.state.municipalityName.toLowerCase();s.startsWith(l.substring(0,Math.min(s.length,l.length)))||(this.log("Resetting context (Municipality name changed)","WARN"),this.resetState())}await this.tryAutoSelectContext(i);let n=[];if(t.length>5&&/\d/.test(t)){let r=await this.apiValidate(t);if(r&&"MATCH"===r.status){this.log("Address is VALID (MATCH)","SUCCESS");let c=r.place,h=this.mapToRuianPlace(c);this.triggerCallback(h);let u=c.streetName||c.municipalityPartName||c.municipalityName,p=c.cp||"";c.co&&(p+="/"+c.co),c.ce&&(p="ev."+c.ce);let o=`${u} ${p}, ${this.formatZip(c.zip)} ${c.municipalityName}`,m=t=>t.replace(/\s+/g," ").trim(),g=m(t);g!==m(o)&&n.unshift({type:"complete",label:o,value:o,data:c}),this.renderSuggestions(n);return}this.triggerCallback(!1)}try{if(this.state.municipalityId&&0!==e){if(this.state.municipalityId&&!this.isNumber(a)&&1===e){this.log(`Searching street in ID ${this.state.municipalityId}: "${a}"`,"INFO");let d=await this.searchStreet(this.state.municipalityId,a);if(n=n.concat(d),0===d.length&&""===a.trim()){let y=await this.searchPlace(this.state.municipalityId,null,a);n=n.concat(y)}}else if(this.state.municipalityId){let N=await this.searchPlace(this.state.municipalityId,this.state.streetName,a);n=n.concat(N)}}else{let f=await this.searchMunicipality(a);if(n=n.concat(f),0===f.length&&i.length>1&&!this.state.municipalityId){let $=await this.searchMunicipality(i[0]);$.length>0&&(n=n.concat($))}}}catch(C){this.log(`Process Error: ${C.message}`,"ERROR")}this.renderSuggestions(n)}async tryAutoSelectContext(t){if(!this.state.municipalityId&&t.length>1){let i=t[0];if(i.length>1){let e=await this.searchMunicipality(i),a=e.find(t=>t.value.toLowerCase()===i.toLowerCase());a&&(this.log(`Auto-selected Municipality: ${a.label}`,"INFO"),this.state.municipalityId=a.data.municipalityId,this.state.municipalityName=a.data.municipalityName,this.state.zip=a.data.zip)}}if(this.state.municipalityId&&!this.state.streetName&&t.length>2){let s=t[1];if(s.length>0&&!this.isNumber(s)){let l=await this.searchStreet(this.state.municipalityId,s),n=l.find(t=>t.value.toLowerCase()===s.toLowerCase());n&&(this.log(`Auto-selected Street: ${n.value}`,"INFO"),this.state.streetName=n.value)}}}mapToRuianPlace(t){return{valid:!0,municipalityId:t.municipalityId,municipalityName:t.municipalityName,municipalityPartId:t.municipalityPartId||null,municipalityPartName:t.municipalityPartName||null,streetName:t.streetName||null,ce:t.ce||null,cp:t.cp||null,co:t.co||null,zip:t.zip,id:t.id,ruianId:t.id,regionId:t.regionId||null,regionName:t.regionName||null,originalString:this.inputElement.value}}async apiValidate(t){if(!this.apiKey)return this.log("Missing API Key!","ERROR"),null;let i=`https://ruian.fnx.io/api/v1/ruian/validate?apiKey=${this.apiKey}`,e=t.match(/^(.+?)\s+(\d+(?:\/\d+)?[a-zA-Z]?)[,\s]+(\d{3}\s?\d{2})\s+(.+)$/);if(e){this.log("Format detected: 'Street Number, ZIP City'","INFO");let a=e[1].trim(),s=e[2].trim(),l=e[3].replace(/\s/g,""),n=e[4].trim(),r=null,c=null;return this.parseNumber(s,(t,i)=>{r=t,c=i}),i+=`&municipalityName=${encodeURIComponent(n)}`,i+=`&street=${encodeURIComponent(a)}`,i+=`&zip=${l}`,r&&(i+=`&cp=${r}`),c&&(i+=`&co=${c}`),this.fetchJson(i)}let h=this.state.municipalityName,u=this.state.streetName,p=null,o=null,m=null,g=t,d=t.match(/\b\d{3}\s?\d{2}\b/);d?(m=d[0].replace(/\s/g,""),g=g.replace(d[0],"")):this.state.zip&&(m=this.state.zip);let y=g.split(/[,]+/).map(t=>t.trim()).filter(t=>t.length>0),N=!1;for(let f=0;f<y.length;f++){let $=y[f],C=$.match(/(\d+(?:\/\d+)?[a-zA-Z]?)$/);if(C){let I=C[1],v=$.substring(0,$.length-I.length).trim();if((0===v.length||v.length>2)&&(v.length>2&&!u&&(u=v),this.parseNumber(I,(t,i)=>{p=t,o=i}),N=!0,y[f]=null),N)break}}let _=y.filter(t=>null!==t);return!h&&_.length>0&&(_.length>=2?(u||(u=_[0]),h=_[_.length-1]):1===_.length&&(u?h=_[0]:this.state.municipalityId?u=_[0]:h=_[0])),!u&&this.state.streetName&&(u=this.state.streetName),!h&&this.state.municipalityName&&(h=this.state.municipalityName),h&&(i+=`&municipalityName=${encodeURIComponent(h)}`),u&&(i+=`&street=${encodeURIComponent(u)}`),p&&(i+=`&cp=${p}`),o&&(i+=`&co=${o}`),m&&(i+=`&zip=${m}`),this.fetchJson(i)}parseNumber(t,i){let e=t.split("/"),a=e[0].replace(/\D/g,"");if(a&&i(a,null),e[1]){let s=e[1].replace(/\D/g,"");s&&i(a,s)}}async searchMunicipality(t){if(/^\d/.test(t)||t.length<2||!this.apiKey)return[];let i=await this.loadAllMunicipalities(),e=t.toLowerCase().trim(),a=i.filter(t=>{let i=t.municipalityName.toLowerCase();return i.includes(e)});a.sort((t,i)=>{let a=t.municipalityName.toLowerCase()===e,s=i.municipalityName.toLowerCase()===e;if(a&&!s)return -1;if(!a&&s)return 1;let l=t.municipalityName.toLowerCase().startsWith(e),n=i.municipalityName.toLowerCase().startsWith(e);return l&&!n?-1:!l&&n?1:t.municipalityName.length!==i.municipalityName.length?t.municipalityName.length-i.municipalityName.length:t.municipalityName.localeCompare(i.municipalityName)});let s={};a.forEach(t=>{let i=t.municipalityName.toLowerCase()+"|"+t.regionId;s[i]=(s[i]||0)+1});let l={};a.forEach(t=>{let i=t.municipalityName.toLowerCase();l[i]=(l[i]||0)+1});let n=a.slice(0,15),r=n.map(async t=>{let i=t.municipalityName.toLowerCase()+"|"+t.regionId,e=s[i]>1;return e?await this.fetchMunicipalityZip(t.municipalityId):null}),c=await Promise.all(r);return n.map((t,i)=>{let e=l[t.municipalityName.toLowerCase()]>1,a=t.municipalityName.toLowerCase()+"|"+t.regionId,n=s[a]>1,r=c[i],h,u=this.formatZip(r);return{type:"municipality",label:h=n&&u?`${t.municipalityName}, ${u} (${t.regionName})`:e?`${t.municipalityName} (${t.regionName})`:t.municipalityName,value:t.municipalityName,data:{municipalityId:t.municipalityId,municipalityName:t.municipalityName,regionId:t.regionId,regionName:t.regionName,zip:r}}})}async searchStreet(t,i){if(!this.apiKey)return[];let e=`https://ruian.fnx.io/api/v1/ruian/build/streets?apiKey=${this.apiKey}&municipalityId=${t}`,a=await this.fetchJson(e);if(!a||!a.data)return[];let s=i.toLowerCase(),l=a.data.filter(t=>{let i=t.streetName||t.streetLessPartName;return i&&i.toLowerCase().includes(s)});return l.slice(0,10).map(t=>({type:"street",label:t.streetName||t.streetLessPartName,value:t.streetName||t.streetLessPartName,data:t}))}async searchPlace(t,i,e){if(!this.apiKey)return[];let a=`https://ruian.fnx.io/api/v1/ruian/build/places?apiKey=${this.apiKey}&municipalityId=${t}`;i&&(a+=`&streetName=${encodeURIComponent(i)}`);let s=await this.fetchJson(a);if(!s||!s.data)return[];let l=e.toLowerCase().trim(),n=s.data.map(t=>{let i="";return t.placeCp&&(i+=t.placeCp),t.placeCo&&(i+="/"+t.placeCo),t.placeCe&&(i="ev."+t.placeCe),{type:"place",label:i,value:i,data:t}}),r=n.filter(t=>{if(!l||t.label.toLowerCase().startsWith(l))return!0;let i=t.data.placeCo?String(t.data.placeCo).toLowerCase():"";if(i.startsWith(l))return!0;let e=t.data.placeCp?String(t.data.placeCp).toLowerCase():"";return!!e.startsWith(l)});return r.slice(0,10)}async fetchJson(t){let i=t.replace(this.apiKey,"***");this.log(`GET ${i}`,"INFO");try{let e=await fetch(t);if(!e.ok)return this.log(`HTTP Error: ${e.status} ${e.statusText}`,"ERROR"),null;let a=await e.json(),s=JSON.stringify(a);return s.length>200&&(s=s.substring(0,200)+"..."),this.log(`Response: ${s}`,"INFO"),a}catch(l){return this.log(`Network Error: ${l.message}`,"ERROR"),null}}renderSuggestions(t){if(this.suggestionBox.innerHTML="",this.suggestionsData=t,this.activeIndex=t.length>0&&"complete"===t[0].type?0:-1,!t||0===t.length){this.closeSuggestions();return}t.forEach((t,i)=>{let e=document.createElement("button");e.className="list-group-item list-group-item-action suggestion-item d-flex align-items-center justify-content-between",i===this.activeIndex&&e.classList.add("active");let a="bg-secondary";"municipality"===t.type&&(a="bg-primary"),"street"===t.type&&(a="bg-warning text-dark"),"place"===t.type&&(a="bg-info text-dark"),"complete"===t.type&&(a="bg-success",e.classList.add("suggestion-complete")),e.innerHTML=`
                <span>${t.label}</span>
                <span class="badge ${a} badge-type">${t.type}</span>
            `,e.onclick=t=>{t.preventDefault(),this.selectSuggestion(i)},this.suggestionBox.appendChild(e)}),this.suggestionBox.style.display="block"}selectSuggestion(t){let i=this.suggestionsData[t];if(i){if(this.log(`Selected: ${i.type} - ${i.label}`,"SUCCESS"),"complete"===i.type){this.inputElement.value=i.value;let e=this.mapToRuianPlace(i.data);this.triggerCallback(e),this.state.municipalityId=i.data.municipalityId,this.state.municipalityName=i.data.municipalityName,this.state.zip=i.data.zip,this.state.streetName=i.data.streetName||null,this.closeSuggestions()}else if("municipality"===i.type)this.state.municipalityId=i.data.municipalityId,this.state.municipalityName=i.data.municipalityName,this.state.zip=i.data.zip,this.state.streetName=null,this.inputElement.value=`${i.data.municipalityName}, `,this.handleInput(this.inputElement.value),this.inputElement.focus();else if("street"===i.type)this.state.streetName=i.value,this.inputElement.value=`${this.state.municipalityName}, ${i.value}, `,this.handleInput(this.inputElement.value),this.inputElement.focus();else if("place"===i.type){let a=`${this.state.municipalityName}, `;this.state.streetName&&(a+=`${this.state.streetName}, `);let s=i.data.placeZip||this.state.zip;this.inputElement.value=`${a}${i.value}, ${this.formatZip(s)}`,this.handleInput(this.inputElement.value),this.inputElement.focus()}}}closeSuggestions(){this.suggestionBox&&(this.suggestionBox.style.display="none"),this.activeIndex=-1}handleKeydown(t){if(!this.suggestionBox||"none"===this.suggestionBox.style.display)return;let i=this.suggestionBox.querySelectorAll(".suggestion-item");"ArrowDown"===t.key?(t.preventDefault(),this.activeIndex=(this.activeIndex+1)%i.length,this.highlightItem(i)):"ArrowUp"===t.key?(t.preventDefault(),this.activeIndex=(this.activeIndex-1+i.length)%i.length,this.highlightItem(i)):"Enter"===t.key?(t.preventDefault(),this.activeIndex>-1&&this.selectSuggestion(this.activeIndex)):"Escape"===t.key&&this.closeSuggestions()}highlightItem(t){t.forEach(t=>t.classList.remove("active")),t[this.activeIndex]&&(t[this.activeIndex].classList.add("active"),t[this.activeIndex].scrollIntoView({block:"nearest"}))}isNumber(t){return/^\d/.test(t.trim())}resetState(){this.state={municipalityId:null,municipalityName:null,zip:null,streetName:null}}triggerCallback(t){!1===t?(this.inputElement.classList.add("is-invalid"),this.inputElement.classList.remove("is-valid"),this.onValidationChange(!1,null)):null===t?(this.inputElement.classList.remove("is-valid","is-invalid"),this.onValidationChange(null,null)):(this.inputElement.classList.remove("is-invalid"),this.inputElement.classList.add("is-valid"),this.onValidationChange(!0,{RUIANplace:t}))}log(t,i){this.onLog(t,i)}}