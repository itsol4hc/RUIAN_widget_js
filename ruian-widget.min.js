class RuianAddressWidget{constructor(t){this.inputElement=t.inputElement,this.suggestionBox=t.suggestionElement,this.apiKey=t.apiKey,this.onValidationChange=t.onValidationChange||function(){},this.onLog=t.onLog||console.log,"object"==typeof t.badgesLabels&&null!==t.badgesLabels?this.badgesLabels=t.badgesLabels:this.badgesLabels={municipality:"municipality",street:"street",place:"place",complete:"complete"},this.cachePreservation=void 0!==t.cachePreservation?t.cachePreservation:24,this.cacheReset=t.cacheReset||!1,this.state={municipalityId:null,municipalityName:null,zip:null,streetName:null},this.allMunicipalities=null,this.municipalitiesLoading=!1,this.zipCache={},this.debounceTimer=null,this.suggestionsData=[],this.activeIndex=-1,this.cacheReset&&(localStorage.removeItem("ruian_municipalities_cache"),this.log("Cache reset on init","INFO")),this.init()}setApiKey(t){this.apiKey=t}init(){this.log("Initializing RUIAN Widget v1.1...","INFO"),this.inputElement.addEventListener("input",(t=>{clearTimeout(this.debounceTimer),this.inputElement.classList.remove("is-valid","is-invalid"),this.debounceTimer=setTimeout((()=>{this.handleInput(t.target.value)}),400)})),this.inputElement.addEventListener("keydown",(t=>this.handleKeydown(t))),document.addEventListener("click",(t=>{t.target===this.inputElement||this.suggestionBox.contains(t.target)||this.closeSuggestions()}))}formatZip(t){if(!t)return"";const i=String(t).replace(/\s/g,"");return 5===i.length?`${i.substring(0,3)} ${i.substring(3)}`:i}loadMunicipalitiesFromCache(){try{const t=localStorage.getItem("ruian_municipalities_cache");if(!t)return null;const i=JSON.parse(t),e=(Date.now()-i.timestamp)/36e5;return e>this.cachePreservation?(this.log(`Cache expired (${e.toFixed(1)}h > ${this.cachePreservation}h)`,"INFO"),null):(this.log(`Loaded ${i.municipalities.length} municipalities from cache (${e.toFixed(1)}h old)`,"SUCCESS"),i.municipalities)}catch(t){return null}}saveMunicipalitiesToCache(t){try{const i={timestamp:Date.now(),municipalities:t};localStorage.setItem("ruian_municipalities_cache",JSON.stringify(i)),this.log(`Saved ${t.length} municipalities to cache`,"SUCCESS")}catch(t){this.log(`Failed to cache municipalities: ${t.message}`,"WARN")}}async loadAllMunicipalities(){if(this.allMunicipalities)return this.allMunicipalities;const t=this.loadMunicipalitiesFromCache();if(t)return this.allMunicipalities=t,t;if(this.municipalitiesLoading){for(;this.municipalitiesLoading;)await new Promise((t=>setTimeout(t,100)));return this.allMunicipalities||[]}this.municipalitiesLoading=!0,this.log("Loading all municipalities from API...","INFO");try{const t=["CZ010","CZ020","CZ031","CZ032","CZ041","CZ042","CZ051","CZ052","CZ053","CZ063","CZ064","CZ071","CZ072","CZ080"],i=[];for(const e of t){const t=`https://ruian.fnx.io/api/v1/ruian/build/municipalities?apiKey=${this.apiKey}&regionId=${e}`,a=await this.fetchJson(t);a&&a.data&&a.data.forEach((t=>{i.push({municipalityId:t.municipalityId,municipalityName:t.municipalityName,regionId:e,regionName:this.getRegionName(e)})}))}this.allMunicipalities=i,this.log(`Loaded ${i.length} municipalities`,"SUCCESS"),this.saveMunicipalitiesToCache(i)}catch(t){this.log(`Error loading municipalities: ${t.message}`,"ERROR")}return this.municipalitiesLoading=!1,this.allMunicipalities||[]}getRegionName(t){return{CZ010:"Hlavní město Praha",CZ020:"Středočeský kraj",CZ031:"Jihočeský kraj",CZ032:"Plzeňský kraj",CZ041:"Karlovarský kraj",CZ042:"Ústecký kraj",CZ051:"Liberecký kraj",CZ052:"Královéhradecký kraj",CZ053:"Pardubický kraj",CZ063:"Kraj Vysočina",CZ064:"Jihomoravský kraj",CZ071:"Olomoucký kraj",CZ072:"Zlínský kraj",CZ080:"Moravskoslezský kraj"}[t]||t}async fetchMunicipalityZip(t){if(this.zipCache[t])return this.zipCache[t];let i=null;try{const e=`https://ruian.fnx.io/api/v1/ruian/validate?apiKey=${this.apiKey}&municipalityId=${t}&cp=1`,a=await this.fetchJson(e);a&&a.place&&(i=a.place.zip||a.place.placeZip)}catch(t){}if(!i)try{const e=`https://ruian.fnx.io/api/v1/ruian/build/places?apiKey=${this.apiKey}&municipalityId=${t}&streetName=-&limit=1`,a=await this.fetchJson(e);a&&a.data&&a.data.length>0?i=a.data[0].placeZip||a.data[0].zip:a&&a.length>0&&(i=a[0].placeZip||a[0].zip)}catch(t){}if(!i)try{const e=`https://ruian.fnx.io/api/v1/ruian/build/streets?apiKey=${this.apiKey}&municipalityId=${t}&limit=1`,a=await this.fetchJson(e),s=a&&a.data?a.data:a;if(s&&s.length>0){const e=s[0].streetName,a=`https://ruian.fnx.io/api/v1/ruian/build/places?apiKey=${this.apiKey}&municipalityId=${t}&streetName=${encodeURIComponent(e)}&limit=1`,n=await this.fetchJson(a),l=n&&n.data?n.data:n;l&&l.length>0&&(i=l[0].placeZip||l[0].zip)}}catch(i){this.log(`Error fetching ZIP for ${t}: ${i.message}`,"ERROR")}return i?(this.zipCache[t]=i,i):null}async handleInput(t){if(!t||t.trim().length<1)return this.closeSuggestions(),void this.triggerCallback(null);const i=t.split(",").map((t=>t.trim())),e=i.length-1,a=i[e];if(0===e&&this.state.municipalityName){const i=t.toLowerCase(),e=this.state.municipalityName.toLowerCase();i.startsWith(e.substring(0,Math.min(i.length,e.length)))||(this.log("Resetting context (Municipality name changed)","WARN"),this.resetState())}await this.tryAutoSelectContext(i);let s=[];if(t.length>5&&/\d/.test(t)){const i=await this.apiValidate(t);if(i&&"MATCH"===i.status){this.log("Address is VALID (MATCH)","SUCCESS");const e=i.place,a=this.mapToRuianPlace(e);this.triggerCallback(a);const n=e.streetName||e.municipalityPartName||e.municipalityName;let l=e.cp||"";e.co&&(l+="/"+e.co),e.ce&&(l="ev."+e.ce);const c=`${n} ${l}, ${this.formatZip(e.zip)} ${e.municipalityName}`,o=t=>t.replace(/\s+/g," ").trim();return o(t)!==o(c)&&s.unshift({type:"complete",label:c,value:c,data:e}),void this.renderSuggestions(s)}this.triggerCallback(!1)}try{if(this.state.municipalityId&&0!==e){if(this.state.municipalityId&&!this.isNumber(a)&&1===e){this.log(`Searching street in ID ${this.state.municipalityId}: "${a}"`,"INFO");const t=await this.searchStreet(this.state.municipalityId,a);if(s=s.concat(t),0===t.length&&""===a.trim()){const t=await this.searchPlace(this.state.municipalityId,null,a);s=s.concat(t)}}else if(this.state.municipalityId){const t=await this.searchPlace(this.state.municipalityId,this.state.streetName,a);s=s.concat(t)}}else{const t=await this.searchMunicipality(a);if(s=s.concat(t),0===t.length&&i.length>1&&!this.state.municipalityId){const t=await this.searchMunicipality(i[0]);t.length>0&&(s=s.concat(t))}}}catch(t){this.log(`Process Error: ${t.message}`,"ERROR")}this.renderSuggestions(s)}async tryAutoSelectContext(t){if(!this.state.municipalityId&&t.length>1){const i=t[0];if(i.length>1){const t=(await this.searchMunicipality(i)).find((t=>t.value.toLowerCase()===i.toLowerCase()));t&&(this.log(`Auto-selected Municipality: ${t.label}`,"INFO"),this.state.municipalityId=t.data.municipalityId,this.state.municipalityName=t.data.municipalityName,this.state.zip=t.data.zip)}}if(this.state.municipalityId&&!this.state.streetName&&t.length>2){const i=t[1];if(i.length>0&&!this.isNumber(i)){const t=(await this.searchStreet(this.state.municipalityId,i)).find((t=>t.value.toLowerCase()===i.toLowerCase()));t&&(this.log(`Auto-selected Street: ${t.value}`,"INFO"),this.state.streetName=t.value)}}}mapToRuianPlace(t){return{valid:!0,municipalityId:t.municipalityId,municipalityName:t.municipalityName,municipalityPartId:t.municipalityPartId||null,municipalityPartName:t.municipalityPartName||null,streetName:t.streetName||null,ce:t.ce||null,cp:t.cp||null,co:t.co||null,zip:t.zip,id:t.id,ruianId:t.id,regionId:t.regionId||null,regionName:t.regionName||null,originalString:this.inputElement.value}}async apiValidate(t){if(!this.apiKey)return this.log("Missing API Key!","ERROR"),null;let i=`https://ruian.fnx.io/api/v1/ruian/validate?apiKey=${this.apiKey}`;const e=t.match(/^(.+?)\s+(\d+(?:\/\d+)?[a-zA-Z]?)[,\s]+(\d{3}\s?\d{2})\s+(.+)$/);if(e){this.log("Format detected: 'Street Number, ZIP City'","INFO");const t=e[1].trim(),a=e[2].trim(),s=e[3].replace(/\s/g,""),n=e[4].trim();let l=null,c=null;return this.parseNumber(a,((t,i)=>{l=t,c=i})),i+=`&municipalityName=${encodeURIComponent(n)}`,i+=`&street=${encodeURIComponent(t)}`,i+=`&zip=${s}`,l&&(i+=`&cp=${l}`),c&&(i+=`&co=${c}`),this.fetchJson(i)}let a=this.state.municipalityName,s=this.state.streetName,n=null,l=null,c=null,o=t;const r=t.match(/\b\d{3}\s?\d{2}\b/);r?(c=r[0].replace(/\s/g,""),o=o.replace(r[0],"")):this.state.zip&&(c=this.state.zip);const h=o.split(/[,]+/).map((t=>t.trim())).filter((t=>t.length>0));let u=!1;for(let t=0;t<h.length;t++){const i=h[t],e=i.match(/(\d+(?:\/\d+)?[a-zA-Z]?)$/);if(e){const a=e[1],c=i.substring(0,i.length-a.length).trim();if((0===c.length||c.length>2)&&(c.length>2&&!s&&(s=c),this.parseNumber(a,((t,i)=>{n=t,l=i})),u=!0,h[t]=null),u)break}}const p=h.filter((t=>null!==t));return!a&&p.length>0&&(p.length>=2?(s||(s=p[0]),a=p[p.length-1]):1===p.length&&(s?a=p[0]:this.state.municipalityId?s=p[0]:a=p[0])),!s&&this.state.streetName&&(s=this.state.streetName),!a&&this.state.municipalityName&&(a=this.state.municipalityName),a&&(i+=`&municipalityName=${encodeURIComponent(a)}`),s&&(i+=`&street=${encodeURIComponent(s)}`),n&&(i+=`&cp=${n}`),l&&(i+=`&co=${l}`),c&&(i+=`&zip=${c}`),this.fetchJson(i)}parseNumber(t,i){const e=t.split("/"),a=e[0].replace(/\D/g,"");if(a&&i(a,null),e[1]){const t=e[1].replace(/\D/g,"");t&&i(a,t)}}async searchMunicipality(t){if(/^\d/.test(t)||t.length<2||!this.apiKey)return[];const i=await this.loadAllMunicipalities(),e=t.toLowerCase().trim(),a=i.filter((t=>t.municipalityName.toLowerCase().includes(e)));a.sort(((t,i)=>{const a=t.municipalityName.toLowerCase()===e,s=i.municipalityName.toLowerCase()===e;if(a&&!s)return-1;if(!a&&s)return 1;const n=t.municipalityName.toLowerCase().startsWith(e),l=i.municipalityName.toLowerCase().startsWith(e);return n&&!l?-1:!n&&l?1:t.municipalityName.length!==i.municipalityName.length?t.municipalityName.length-i.municipalityName.length:t.municipalityName.localeCompare(i.municipalityName)}));const s={};a.forEach((t=>{const i=t.municipalityName.toLowerCase()+"|"+t.regionId;s[i]=(s[i]||0)+1}));const n={};a.forEach((t=>{const i=t.municipalityName.toLowerCase();n[i]=(n[i]||0)+1}));const l=a.slice(0,15),c=l.map((async t=>{const i=t.municipalityName.toLowerCase()+"|"+t.regionId;return s[i]>1?await this.fetchMunicipalityZip(t.municipalityId):null})),o=await Promise.all(c);return l.map(((t,i)=>{const e=n[t.municipalityName.toLowerCase()]>1,a=t.municipalityName.toLowerCase()+"|"+t.regionId,l=s[a]>1,c=o[i];let r;const h=this.formatZip(c);return r=l&&h?`${t.municipalityName}, ${h} (${t.regionName})`:e?`${t.municipalityName} (${t.regionName})`:t.municipalityName,{type:"municipality",label:r,value:t.municipalityName,data:{municipalityId:t.municipalityId,municipalityName:t.municipalityName,regionId:t.regionId,regionName:t.regionName,zip:c}}}))}async searchStreet(t,i){if(!this.apiKey)return[];const e=`https://ruian.fnx.io/api/v1/ruian/build/streets?apiKey=${this.apiKey}&municipalityId=${t}`,a=await this.fetchJson(e);if(!a||!a.data)return[];const s=i.toLowerCase();return a.data.filter((t=>{const i=t.streetName||t.streetLessPartName;return i&&i.toLowerCase().includes(s)})).slice(0,10).map((t=>({type:"street",label:t.streetName||t.streetLessPartName,value:t.streetName||t.streetLessPartName,data:t})))}async searchPlace(t,i,e){if(!this.apiKey)return[];let a=`https://ruian.fnx.io/api/v1/ruian/build/places?apiKey=${this.apiKey}&municipalityId=${t}`;i&&(a+=`&streetName=${encodeURIComponent(i)}`);const s=await this.fetchJson(a);if(!s||!s.data)return[];const n=e.toLowerCase().trim();return s.data.map((t=>{let i="";return t.placeCp&&(i+=t.placeCp),t.placeCo&&(i+="/"+t.placeCo),t.placeCe&&(i="ev."+t.placeCe),{type:"place",label:i,value:i,data:t}})).filter((t=>{if(!n)return!0;if(t.label.toLowerCase().startsWith(n))return!0;if((t.data.placeCo?String(t.data.placeCo).toLowerCase():"").startsWith(n))return!0;return!!(t.data.placeCp?String(t.data.placeCp).toLowerCase():"").startsWith(n)})).slice(0,10)}async fetchJson(t){const i=t.replace(this.apiKey,"***");this.log(`GET ${i}`,"INFO");try{const i=await fetch(t);if(!i.ok)return this.log(`HTTP Error: ${i.status} ${i.statusText}`,"ERROR"),null;const e=await i.json();let a=JSON.stringify(e);return a.length>200&&(a=a.substring(0,200)+"..."),this.log(`Response: ${a}`,"INFO"),e}catch(t){return this.log(`Network Error: ${t.message}`,"ERROR"),null}}renderSuggestions(t){this.suggestionBox.innerHTML="",this.suggestionsData=t,this.activeIndex=t.length>0&&"complete"===t[0].type?0:-1,t&&0!==t.length?(t.forEach(((t,i)=>{const e=document.createElement("button");e.className="list-group-item list-group-item-action suggestion-item d-flex align-items-center justify-content-between",i===this.activeIndex&&e.classList.add("active");let a="bg-secondary";"municipality"===t.type&&(a="bg-primary"),"street"===t.type&&(a="bg-warning text-dark"),"place"===t.type&&(a="bg-info text-dark"),"complete"===t.type&&(a="bg-success",e.classList.add("suggestion-complete")),e.innerHTML=`\n                <span>${t.label}</span>\n                <span class="badge ${a} badge-type">${this.badgesLabels[t.type]}</span>\n            `,e.onclick=t=>{t.preventDefault(),this.selectSuggestion(i)},this.suggestionBox.appendChild(e)})),this.suggestionBox.style.display="block"):this.closeSuggestions()}selectSuggestion(t){const i=this.suggestionsData[t];if(i)if(this.log(`Selected: ${i.type} - ${i.label}`,"SUCCESS"),"complete"===i.type){this.inputElement.value=i.value;const t=this.mapToRuianPlace(i.data);this.triggerCallback(t),this.state.municipalityId=i.data.municipalityId,this.state.municipalityName=i.data.municipalityName,this.state.zip=i.data.zip,this.state.streetName=i.data.streetName||null,this.closeSuggestions()}else if("municipality"===i.type)this.state.municipalityId=i.data.municipalityId,this.state.municipalityName=i.data.municipalityName,this.state.zip=i.data.zip,this.state.streetName=null,this.inputElement.value=`${i.data.municipalityName}, `,this.handleInput(this.inputElement.value),this.inputElement.focus();else if("street"===i.type)this.state.streetName=i.value,this.inputElement.value=`${this.state.municipalityName}, ${i.value}, `,this.handleInput(this.inputElement.value),this.inputElement.focus();else if("place"===i.type){let t=`${this.state.municipalityName}, `;this.state.streetName&&(t+=`${this.state.streetName}, `);const e=i.data.placeZip||this.state.zip;this.inputElement.value=`${t}${i.value}, ${this.formatZip(e)}`,this.handleInput(this.inputElement.value),this.inputElement.focus()}}closeSuggestions(){this.suggestionBox&&(this.suggestionBox.style.display="none"),this.activeIndex=-1}handleKeydown(t){if(!this.suggestionBox||"none"===this.suggestionBox.style.display)return;const i=this.suggestionBox.querySelectorAll(".suggestion-item");"ArrowDown"===t.key?(t.preventDefault(),this.activeIndex=(this.activeIndex+1)%i.length,this.highlightItem(i)):"ArrowUp"===t.key?(t.preventDefault(),this.activeIndex=(this.activeIndex-1+i.length)%i.length,this.highlightItem(i)):"Enter"===t.key?(t.preventDefault(),this.activeIndex>-1&&this.selectSuggestion(this.activeIndex)):"Escape"===t.key&&this.closeSuggestions()}highlightItem(t){t.forEach((t=>t.classList.remove("active"))),t[this.activeIndex]&&(t[this.activeIndex].classList.add("active"),t[this.activeIndex].scrollIntoView({block:"nearest"}))}isNumber(t){return/^\d/.test(t.trim())}resetState(){this.state={municipalityId:null,municipalityName:null,zip:null,streetName:null}}triggerCallback(t){!1===t?(this.inputElement.classList.add("is-invalid"),this.inputElement.classList.remove("is-valid"),this.onValidationChange(!1,null)):null===t?(this.inputElement.classList.remove("is-valid","is-invalid"),this.onValidationChange(null,null)):(this.inputElement.classList.remove("is-invalid"),this.inputElement.classList.add("is-valid"),this.onValidationChange(!0,{RUIANplace:t}))}log(t,i){this.onLog(t,i)}}